# stm32 中断

[toc]

## 1 相关概念


### 1.1 中断

STM32F10x系列单片机的中断是一种事件触发的机制，用于响应和处理特定的硬件或软件事件。当发生一个中断事件时，中断控制器（Nested Vectored Interrupt Controller，NVIC）会暂停当前的程序执行，转而执行与该中断事件相关的中断处理函数，处理完后再返回到原来的程序继续执行。

中断可以分为外部中断和内部中断两种类型：

1. 外部中断：由外部设备（如按键、传感器等）产生的中断事件，可以通过外部引脚连接到单片机的外部中断输入引脚（例如EXTI0、EXTI1等）。当外部中断引脚上的信号发生变化时（例如上升沿、下降沿、边沿触发等），会触发相应的外部中断事件。

2. 内部中断：由单片机内部模块（如定时器、串口等）产生的中断事件。这些模块在特定条件下（如定时器溢出、接收到数据等）会触发中断事件。

通过配置中断控制器的相关寄存器和编写中断处理函数，可以实现对中断的管理和处理。中断优先级可以设置，以确定在多个中断同时发生时的执行顺序。中断处理函数负责处理中断事件，并可以进行相关的数据处理、状态更新等操作。

中断的使用可以提高系统的实时性和响应能力，适用于需要及时处理外部事件或周期性任务的应用场景。

### 1.2 边沿

在数字电路中，边沿是指信号从一个状态转变到另一个状态的瞬间。边沿通常被用来触发或同步电路的操作。

常见的边沿类型包括上升沿和下降沿：

1. 上升沿（Rising Edge）：信号从低电平（0）切换到高电平（1）时的边沿。

2. 下降沿（Falling Edge）：信号从高电平（1）切换到低电平（0）时的边沿。

边沿触发可以用于触发器、时钟信号同步、数据采样等应用。通过检测信号的边沿，可以确定合适的时机来进行操作或采样。

例如，在时序控制中，上升沿触发可以用来触发状态转换或启动某个操作；下降沿触发可以用来同步数据采样，确保在信号稳定后进行采样操作。

在中断处理中，常常使用边沿触发来检测外部事件或信号的变化，当信号的边沿触发中断时，相应的中断服务程序将被执行。

总之，边沿指的是信号从一个状态到另一个状态的瞬间，上升沿和下降沿是常见的边沿类型，用于触发或同步数字电路的操作。

![](https://pic1.imgdb.cn/item/646ad07ee03e90d8744a734b.jpg)


### 1.3 中断优先级

在STM32F10x系列单片机中，每个中断源都有一个对应的中断优先级。中断优先级决定了在多个中断同时发生时，处理器按照何种顺序来处理这些中断。

STM32F10x系列单片机的中断优先级采用了分组优先级的方式，其中分为两个组别：抢占优先级和子优先级。

抢占优先级（Preemption Priority）用于确定哪个中断具有更高的优先级，即可以打断正在执行的中断或任务。较高的抢占优先级的中断可以中断较低的抢占优先级中断的执行。

子优先级（Subpriority）则用于确定同一抢占优先级组别内多个中断的优先级顺序。具有相同抢占优先级的中断，根据子优先级来确定先后顺序。

在配置中断优先级时，可以根据系统需求为每个中断源设置不同的抢占优先级和子优先级。较高优先级的中断将会优先得到处理，而较低优先级的中断则需要等待较高优先级的中断处理完毕。

需要注意的是，优先级的数值越低，表示优先级越高。抢占优先级和子优先级的位数取决于具体的单片机型号和中断控制器的配置。在配置中断优先级时，需要参考芯片手册或相关的开发工具文档，了解具体的位数和取值范围。

通过合理配置中断优先级，可以确保关键中断得到及时响应和处理，提高系统的可靠性和实时性。

### 1.4 USART空闲总线


在USART通信中，空闲总线是指数据线保持在空闲状态（逻辑高电平）的时间段。它是由发送方在数据传输完成后将数据线置于逻辑高电平状态，表示数据传输结束并处于空闲状态的时间段。

在USART通信中，数据的传输是通过数据线进行的，数据以位的形式传输。当没有数据传输时，数据线应该保持在空闲状态以便接收新的数据。空闲总线时间段用于表示两个连续数据帧之间的间隔。

接收方利用空闲总线时间段来判断数据帧的开始和结束。当接收方检测到数据线从逻辑高电平转为逻辑低电平时，它开始接收数据帧。当接收方连续检测到数据线保持在逻辑高电平一段时间后，它认为数据帧已传输完成，并进行数据处理。

因此，空闲总线时间段是在USART通信中用于表示数据帧之间的间隔的概念，并不是特定的寄存器配置或电信号线路。


在USART通信中，空闲总线时间段是通过检测数据线的状态来确定的。当数据线保持在逻辑高电平状态时，表示处于空闲状态。为了确保接收方能够正确地判断空闲状态，通常需要满足以下条件：

数据帧的起始位为逻辑低电平：在USART通信中，数据帧的开始由一个起始位标识。该起始位通常为逻辑低电平，表示数据帧的开始。接收方在检测到起始位的逻辑低电平后，开始接收数据。

数据帧的停止位为逻辑高电平：在USART通信中，数据帧的结束由一个或多个停止位标识。停止位通常为逻辑高电平，表示数据帧的结束。接收方在检测到停止位的逻辑高电平后，认为数据传输已完成，并进行数据处理。

通过检测起始位和停止位的电平状态，接收方能够确定数据帧的边界，并在空闲状态时进行数据接收。如果数据线在起始位和停止位之间保持逻辑高电平状态，接收方将识别为空闲状态，并等待下一个数据帧的到来。

要确保正确判断空闲状态，需要根据具体的USART通信配置和协议要求进行相应的设置和处理。通常，可以通过USART模块的配置寄存器来设置起始位和停止位的极性和位数，以及相应的数据位和校验位配置，以满足具体的通信需求。

总结起来，通过起始位和停止位的定义和检测，接收方能够区分数据位和空闲状态，确保正确接收和处理数据。

## 2.内部中断和外部中断

### 2.1 NVIC

在STM32F10x系列单片机中，内部中断是通过中断控制器（Nested Vector Interrupt Controller，NVIC）实现的。NVIC是一个集成在芯片内部的硬件模块，用于管理和控制中断。它负责处理和分发所有的中断请求，并根据优先级和中断类型来决定中断的触发和执行顺序。

STM32F10x系列单片机的NVIC具有多个中断通道，每个通道可以与特定的外设或事件相关联。通过配置NVIC的寄存器，可以设置中断的优先级、使能或禁用特定的中断，并定义中断服务函数。

通过NVIC，内部中断可以与芯片内部的各种外设进行集成，例如定时器、串口、SPI、I2C等。当相应的外设触发中断时，NVIC会相应地处理中断请求，并跳转到事先定义的中断服务函数来执行特定的操作。

需要注意的是，具体的内部中断支持和配置取决于不同的STM32F10x系列单片机型号和型号的不同芯片。因此，在编写内部中断代码时，应参考相关的芯片手册和编程参考手册，以确保正确配置和使用中断功能。

### 3.1 EXTI

EXTI模块是STM32系列单片机独有的外部中断控制器。它与GPIO模块紧密结合，用于检测外部中断引脚的状态变化，并产生中断请求。EXTI模块可以配置多个外部中断线，每个中断线对应一个或多个GPIO引脚。当外部中断引脚的电平或边沿发生变化时，EXTI模块会检测到中断请求，**并将其转发给NVIC模块**。

通过配置EXTI模块的触发方式、中断使能和优先级，以及使用NVIC模块设置中断的优先级和处理函数，可以实现对外部中断的管理和处理。

需要注意的是，具体的外部中断引脚和中断线的映射关系，以及中断触发方式的选择，会根据具体的STM32F10x系列单片机型号和引脚布局有所不同。因此，在使用外部中断时，需要查阅相关的芯片文档和外设库手册，了解具体芯片的外部中断功能和使用方法。

### 3.2 内部中断和外部中断的区别

内部中断和外部中断是两种不同的中断类型，它们在触发条件和处理方式上有所不同。

1. 触发条件：
   - 内部中断：内部中断是由处理器内部的事件或异常引发的中断，例如除零错误、非法指令、内存访问错误等。这些事件通常与程序执行相关，由处理器自动触发中断。
   - 外部中断：外部中断是由外部设备或外部信号触发的中断，例如按键输入、外部传感器信号、定时器溢出等。这些事件通常与处理器外部环境或外部设备交互相关，需要通过相应的硬件电路来触发中断。

2. 处理方式：
   - 内部中断：内部中断的处理是在处理器内部完成的。当触发内部中断时，处理器会自动跳转到相应的中断处理程序进行处理，然后在处理完毕后返回到原来的执行点。
   - 外部中断：外部中断的处理是通过硬件电路和中断控制器实现的。当外部中断事件发生时，硬件电路会生成中断请求信号，中断控制器会将中断请求转发给处理器。处理器根据中断优先级和配置的中断处理函数来执行相应的中断处理。

总体而言，内部中断通常与处理器内部的异常和错误相关，由处理器自动触发和处理。而外部中断通常与外部设备和外部环境交互相关，需要通过硬件电路和中断控制器来触发和处理。


## 2 设置中断的步骤

### 2.1 内部中断

设置STM32F10x系列单片机内部中断的步骤如下：

1. 配置中断优先级：
   - 使用NVIC（Nested Vectored Interrupt Controller）寄存器来配置中断优先级。
   - 使用`NVIC_SetPriority()`函数设置中断源的优先级。

2. 使能中断源：
   - 配置相关的外设以产生中断请求。
   - 例如，对于USART通信，需要配置USART的接收中断使能位。

3. 编写中断服务程序（ISR）：
   - 定义中断服务程序函数，用于处理中断事件。
   - 中断服务程序函数的命名需符合特定的命名规则，例如`void USART1_IRQHandler(void)`。

4. 注册中断服务程序：
   - 将中断服务程序函数注册到中断向量表中。
   - 中断向量表是由编译器或链接器生成的表格，存储了每个中断向量的地址。
   - 在STM32F10x系列单片机中，中断向量表的起始地址是固定的，不需要手动配置。

5. 使能全局中断：
   - 使用`__enable_irq()`函数或类似的指令来使能全局中断。
   - 这将允许所有中断请求被接收和处理。

以下是基于STM32F10x标准外设库的USART通信内部中断案例：

```c
#include "stm32f10x.h"

void USART1_IRQHandler(void)
{
    if (USART_GetITStatus(USART1, USART_IT_RXNE) != RESET)
    {
        // 处理USART接收中断事件
        uint8_t data = USART_ReceiveData(USART1);
        // 处理接收到的数据
    }
}

int main(void)
{
    // 初始化USART1外设和相关GPIO等

    NVIC_InitTypeDef NVIC_InitStructure;
    USART_InitTypeDef USART_InitStructure;

    // 使能USART1的接收中断
    USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);

    // 配置中断优先级
    NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0; // 抢占优先级
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;        // 子优先级
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStructure);

    // 使能全局中断
    __enable_irq();

    while (1)
    {
        // 主程序逻辑
    }
}
```

上述代码中，通过配置USART1的接收中断使能位以及中断优先级，以实现USART通信的内部中断功能。当接收到数据时，中断服务程序`USART1_IRQHandler()`会被自动调用，可以在该函数中处理接收到的数据。在`main()`函数中，使用`NVIC_Init()`函数配置中断优先级，使用`__enable_irq()`函数使能全局中断。最后，在主循环中可以编写其他的主程序逻辑。

请注意，具体的配置和初始化步骤可能会

因芯片型号和使用的开发环境而有所不同。建议参考相应的芯片数据手册和编程手册以获取准确的配置信息。


### 2.2 外部中断

设置STM32F10x系列单片机外部中断的步骤如下：

1. 配置中断引脚：
   - 确定外部中断的触发方式（上升沿、下降沿或双边沿）。
   - 配置相应的GPIO引脚，将其设置为输入模式，并使能外部中断功能。

2. 配置中断优先级：
   - 使用NVIC寄存器来配置中断优先级。
   - 使用`NVIC_SetPriority()`函数设置中断源的优先级。

3. 编写中断服务程序（ISR）：
   - 定义中断服务程序函数，用于处理中断事件。
   - 中断服务程序函数的命名需符合特定的命名规则，例如`void EXTIx_IRQHandler(void)`，其中x为外部中断线的编号。

4. 注册中断服务程序：
   - 将中断服务程序函数注册到中断向量表中。
   - 中断向量表是由编译器或链接器生成的表格，存储了每个中断向量的地址。
   - 在STM32F10x系列单片机中，中断向量表的起始地址是固定的，不需要手动配置。

5. 使能全局中断：
   - 使用`__enable_irq()`函数或类似的指令来使能全局中断。
   - 这将允许所有中断请求被接收和处理。

以下是基于STM32F10x标准外设库的按键输入外部中断案例：

```c
#include "stm32f10x.h"

void EXTI0_IRQHandler(void)
{
    if (EXTI_GetITStatus(EXTI_Line0) != RESET)
    {
        // 处理按键中断事件
        // ...

        // 清除中断标志位
        EXTI_ClearITPendingBit(EXTI_Line0);
    }
}

int main(void)
{
    // 初始化按键引脚和相关GPIO等

    NVIC_InitTypeDef NVIC_InitStructure;
    EXTI_InitTypeDef EXTI_InitStructure;

    // 配置中断引脚为上升沿触发方式
    GPIO_EXTILineConfig(GPIO_PortSourceGPIOA, GPIO_PinSource0);
    EXTI_InitStructure.EXTI_Line = EXTI_Line0;
    EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;
    EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Rising;
    EXTI_InitStructure.EXTI_LineCmd = ENABLE;
    EXTI_Init(&EXTI_InitStructure);

    // 配置中断优先级
    NVIC_InitStructure.NVIC_IRQChannel = EXTI0_IRQn;
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0; // 抢占优先级
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;        // 子优先级
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStructure);

    // 使能全局中断
    __enable_irq();

    while (1)
    {
        // 主程序逻辑
    }
}
```

上述代码中，通过配置PA0引脚为上升沿触发方式的外部中断，并设置中断优先级，以实

现按键输入的中断处理。在中断服务程序中，可以编写相应的按键处理逻辑。请注意，具体的引脚配置和外设库函数的使用可能会因具体的芯片型号和开发环境而有所不同，请参考相关的芯片数据手册和编程手册以获取准确的配置信息。

## 3 什么时候应该使用中断


## 4 demo

