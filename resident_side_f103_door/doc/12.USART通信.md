# USART通信

[toc]

## 1 通信概念

### 1.1 同步和异步设备通信

同步通信和异步通信是两种不同的通信方式，用于描述数据传输中的时序和协调机制。

1. 同步通信（Synchronous Communication）：
同步通信是指在数据传输过程中，发送方和接收方之间严格按照预定的时钟或时序进行协调。发送方在发送数据之后会等待接收方的确认或响应，然后再进行下一步操作。这种方式要求发送方和接收方的时钟保持同步，并且需要双方的速度匹配，以确保数据的正确传输。同步通信的特点是简单、可靠，但对时序要求较高，如果出现故障或时钟偏移，可能会导致通信错误。

2. 异步通信（Asynchronous Communication）：
异步通信是指在数据传输过程中，发送方和接收方之间没有严格的时钟同步要求。发送方在发送数据之后不会等待接收方的确认或响应，而是继续执行后续操作。接收方通过特定的机制（如中断、轮询等）来检测和接收数据。异步通信不需要严格的时序同步，可以灵活适应不同速度和处理能力的设备之间的数据交换。然而，异步通信可能会面临数据丢失或冲突的问题，需要适当的协议和机制来处理。

选择同步通信还是异步通信取决于具体的应用需求和系统设计。同步通信适用于对时序要求较高、需要确保数据可靠性的场景，例如高速数据传输、实时控制等。异步通信适用于数据传输较为灵活、设备间速度和处理能力差异较大的场景，例如异步串行通信、设备间的消息传递等。

需要注意的是，同步通信和异步通信不仅仅局限于物理层或传输层的数据传输，也可以应用于更高层次的通信协议和接口设计中，以实现不同层次的数据协调和交互。

## 1.2 全双工和半双工通信

全双工通信和半双工通信是两种不同的通信模式，用于描述数据传输中的双向通信能力。

1. 全双工通信（Full-Duplex Communication）：
全双工通信是指通信双方可以同时进行双向数据传输，即发送方和接收方可以同时发送和接收数据。在全双工通信中，发送方和接收方之间有独立的通信通道，可以同时进行双向数据的传输。这种通信模式实现了实时的双向数据交流，可以在同一时间进行发送和接收操作。典型的全双工通信方式是电话通信，其中两个人可以同时说话和听对方说话。

2. 半双工通信（Half-Duplex Communication）：
半双工通信是指通信双方在不同时间段内交替进行数据传输，即发送方和接收方不能同时进行数据的发送和接收。在半双工通信中，发送方和接收方共享同一个通信通道，它们必须依次轮流使用该通道进行数据传输。当发送方发送数据时，接收方只能等待，反之亦然。典型的半双工通信方式是对讲机通信，其中只有一个人能够说话，当一个人说话时，其他人必须等待。

选择全双工通信还是半双工通信取决于具体的应用需求和系统设计。全双工通信提供了实时的双向数据交流能力，适用于需要同时进行双向数据传输的场景，例如实时音视频通信、网络通信等。半双工通信虽然不能实现同时的双向通信，但对于某些场景仍然足够，例如简单对话、请求-响应式的数据交互等。

需要根据具体应用需求和通信环境来选择适当的通信模式，以满足双向通信的要求。有些通信接口或协议可以同时支持全双工和半双工通信，具体的实现方式取决于硬件设计和协议规范。

## 1.3 串行和并行

串行和并行是两种不同的数据传输方式，描述了数据在传输过程中的排列方式。

1. 串行传输（Serial Transmission）：
串行传输是指数据以连续的位序列的形式逐位传输。在串行传输中，数据位按照顺序一个接一个地传输，每个位依次传输完毕后才传输下一个位。串行传输只使用单条数据线或信道来传输数据，因此传输速率相对较低。然而，串行传输具有较好的抗干扰性能，能够适应长距离传输和复杂环境。

2. 并行传输（Parallel Transmission）：
并行传输是指数据以多个位同时传输的方式进行传输。在并行传输中，每个数据位都使用单独的数据线或信道来传输，可以同时传输多个数据位。并行传输的传输速率相对较高，可以实现较高的数据吞吐量。然而，并行传输的实现需要更多的数据线或信道，并且对于长距离传输和抗干扰能力要求较高。

选择串行传输还是并行传输取决于具体的应用需求、传输距离和系统设计。一般来说，串行传输适用于长距离传输、抗干扰要求高、数据传输速率不是关键因素的场景，例如串行通信接口（如串行通信协议、串行总线）和网络通信。并行传输适用于短距离传输、高速数据传输和数据吞吐量要求高的场景，例如内部数据总线和高速并行接口（如并行接口、并行总线）。

需要根据具体应用需求、传输距离、数据速率和系统设计来选择适当的传输方式，以满足数据传输的要求。有些系统甚至可以同时使用串行传输和并行传输，以兼顾不同的需求。

## 1.4 串口

串口（Serial Port）是一种用于串行通信的接口，用于在计算机系统和外部设备之间传输数据。串口通过发送和接收数据位的连续串行流来传输数据，相比并行传输，它只使用一条数据线进行数据传输。

串口通信一般使用异步传输方式，其中数据帧由起始位、数据位、校验位和停止位组成。常见的串口通信标准包括RS-232、RS-485、UART等。

串口通信具有以下特点：
1. 简单性：串口通信只需要一对数据线（发送线和接收线），相对于并行通信而言更为简单。
2. 抗干扰性：由于串行通信只使用一条数据线，较少受到外部干扰的影响，具有较好的抗干扰性能。
3. 距离限制：串口通信的传输距离相对较短，通常在几米至几十米范围内。
4. 速率灵活：串口通信支持不同的数据传输速率，可以根据需求进行配置。
5. 广泛应用：串口通信广泛应用于各种领域，包括计算机通信、嵌入式系统、工业控制、通信设备等。

在嵌入式系统中，串口常用于与外部设备进行数据通信，例如与传感器、显示器、无线模块、调试工具等进行数据交互。通过串口，可以实现数据的发送和接收，从而实现与外部设备的数据交换和控制。在开发过程中，通过配置串口参数和使用相关的串口通信协议，可以实现可靠的数据传输和通信控制。

## 2 USART

USART是全双工, 同步异步可选择的, 串行的通信方式, 它一般用于两台设备之间的通信

### 2.1 USART模块
STM32系列微控制器的USART模块支持硬件流控（Hardware Flow Control）功能。硬件流控是一种通过硬件信号线来控制数据传输的机制，用于协调发送方和接收方之间的数据流量，以避免数据丢失或溢出。

在STM32的USART模块中，硬件流控通常通过两个信号线实现：RTS（Request to Send）和CTS（Clear to Send）。具体功能如下：

1. RTS（Request to Send）：发送方使用RTS信号线向接收方发出请求，要求其准备接收数据。当发送缓冲区中有足够的空间时，发送方会将RTS信号置为低电平，表示可以发送数据。

2. CTS（Clear to Send）：接收方使用CTS信号线向发送方发送确认信号，表示已准备好接收数据。当接收缓冲区有足够的空间来存储数据时，接收方将CTS信号置为低电平，表示可以接收数据。

通过硬件流控功能，可以有效控制数据的传输，避免发送方发送过多数据导致接收方缓冲区溢出，或者接收方无法及时接收数据导致发送方缓冲区溢出。

在STM32中，可以通过配置USART的控制寄存器来使能硬件流控功能，并设置相应的RTS和CTS引脚。具体的配置方法和使用细节可以参考STM32的相关文档和参考手册，以及使用的开发工具的文档。

USART 硬件控流
![](https://pic1.imgdb.cn/item/64677c19e03e90d8749d5904.jpg)

### 2.2 波特率 和 波特率发生器

#### 2.2.1 波特率
波特率（Baud Rate）是指串行通信中单位时间内传输的比特数。它表示在每秒钟内可以传输的位数。波特率决定了数据在串口中传输的速度，它是串行通信中的一个重要参数。

波特率通常用单位时间内传输的比特数来表示，单位为波特（Baud）。例如，一个波特率为9600的串口表示每秒钟可以传输9600个位。

在串口通信中，发送端和接收端必须使用相同的波特率才能正确地进行数据传输。如果波特率不匹配，数据可能会出现错误或无法正确解析。

常见的串口波特率包括9600、19200、38400、115200等，具体的波特率选择要根据应用需求和硬件支持来确定。在配置串口通信时，需要确保发送端和接收端都设置了相同的波特率，以保证数据能够正确传输。

#### 2.2.2 波特率发生器

波特率发生器（Baud Rate Generator）是用于生成串口通信中的数据传输速率，即波特率（Baud Rate）。在串口通信中，波特率指的是每秒传输的位数。波特率发生器通常与串口控制器或串口通信模块一起使用，用于生成时钟信号来驱动数据的传输。

波特率发生器根据所设定的波特率值和系统时钟频率来生成相应的时钟信号。它可以根据波特率的要求调整时钟频率的分频比例，以确保数据在指定的速率下进行传输。

在STM32系列的微控制器中，通常会有一个专用的波特率发生器模块（比如USART或UART）来生成所需的波特率。通过配置波特率发生器的寄存器，可以设置波特率的值和其他相关参数，例如停止位、数据位和校验位等。

使用波特率发生器，可以确保发送端和接收端之间的数据传输速率一致，从而实现可靠的串口通信。

#### 2.2.3 奇偶检验

奇偶校验（Parity Check）是一种错误检测方法，用于验证数据传输过程中的数据的准确性。它通过在数据中添加一个附加位，即校验位，来检测传输过程中可能出现的单比特错误。

在奇偶校验中，校验位的值取决于数据中的比特数中的奇偶性。具体地说，可以有两种类型的奇偶校验：奇校验和偶校验。

- 奇校验：校验位被设置为使整个数据的比特数（包括校验位）为奇数。例如，如果数据中的比特数为偶数，则校验位被设置为1，以使总比特数为奇数。
- 偶校验：校验位被设置为使整个数据的比特数（包括校验位）为偶数。例如，如果数据中的比特数为奇数，则校验位被设置为1，以使总比特数为偶数。

在发送端，数据和校验位一起被发送到接收端。在接收端，接收到的数据会进行校验，检查校验位是否与数据中的奇偶性一致。如果校验位与数据奇偶性匹配，则认为数据传输正确；如果不匹配，则认为数据传输存在错误。

奇偶校验通常用于串行通信中，特别是在较低的数据传输速率下。它可以检测并纠正单比特错误，但对于多比特错误无法提供纠正能力。因此，在高可靠性的数据传输中，通常需要使用更强大的错误检测和纠正方法，如循环冗余校验（CRC）等。

需要注意的是，奇偶校验只能检测错误，而无法自动纠正错误。因此，在应用中，通常需要结合其他错误检测和纠正机制来实现可靠的数据传输。

**如果校验位也是错误的，那么奇偶校验无法检测到错误** ，并且无法纠正数据传输中的错误。在这种情况下，接收端会误以为数据传输是正确的，导致数据的准确性受到破坏。

奇偶校验的目的是检测单比特错误，即在传输过程中发生的一个位翻转。但是，它并不能检测到多比特错误或者校验位本身出错的情况。因此，奇偶校验通常被认为是一种简单的错误检测机制，适用于低速率或者对数据准确性要求不高的通信环境。

对于对数据完整性要求更高的应用，通常需要采用更复杂的错误检测和纠正技术，如循环冗余校验（CRC），这可以检测和纠正更多的错误类型，提供更高的可靠性。此外，还可以使用重传机制、数据确认机制等来确保数据的正确传输。

#### 2.2.3.4 循环冗余校验

循环冗余校验（Cyclic Redundancy Check，CRC）是一种常用的数据校验方法，用于检测和纠正数据传输过程中的错误。它通过在发送端计算校验值，并在接收端重新计算校验值进行比对，以确定数据是否被改变或损坏。

CRC使用一个固定的生成多项式，通常是一个二进制数，用于进行校验计算。发送端根据生成多项式对数据进行计算，生成一个校验值，然后将数据和校验值一起发送。接收端使用相同的生成多项式对接收到的数据进行计算，得到一个校验值，并将其与接收到的校验值进行比较。

如果接收端计算得到的校验值与接收到的校验值相匹配，说明数据在传输过程中没有发生错误；如果校验值不匹配，说明数据发生了错误或损坏。

循环冗余校验具有以下特点：
1. 可以检测多比特错误：CRC可以检测多个比特的错误，包括奇数个比特和偶数个比特的错误。
2. 高错误检测率：CRC能够检测到大部分常见的传输错误，包括位翻转、插入、删除等。
3. 低概率冲突：CRC使用的生成多项式经过精心设计，使得错误数据在校验计算中与正确数据产生冲突的概率非常低。

循环冗余校验广泛应用于各种通信协议和存储介质中，例如以太网、无线通信、存储设备等，以提供可靠的数据传输和存储保护。

循环冗余校验（CRC）是一种检错技术，主要用于检测数据传输过程中的错误。它可以检测大部分常见的传输错误，但不能百分之百保证数据是正确的。

虽然CRC可以有效地检测错误，但它无法区分出错误是由哪些具体的比特位引起的，也无法提供错误的修复能力。在极少数情况下，CRC可能会将某些错误数据误判为正确，或者无法检测出某些特定类型的错误。

另外，CRC的可靠性也受到生成多项式的选择和使用方法的影响。不同的生成多项式可能对不同类型的错误有不同的检测能力，因此在实际应用中需要选择适合具体需求的生成多项式，并结合适当的校验方法和数据处理策略来提高校验的准确性。

综上所述，虽然循环冗余校验可以在大多数情况下有效检测错误，但并不能百分之百保证数据是正确的。因此，在数据传输和存储的应用中，通常会采用多重校验和冗余机制，以增加数据的可靠性和完整性。


#### 2.3.5 USART 数据帧

![](https://pic1.imgdb.cn/item/64677c9de03e90d8749e89d5.jpg)

USART（通用同步/异步收发器）数据帧是在串口通信中用于传输数据的基本单元。它由一系列位组成，包括起始位、数据位、校验位和停止位。

以下是USART数据帧的组成部分：

1. 起始位（Start Bit）：它指示数据传输的开始，通常为逻辑低电平（0）。
2. 数据位（Data Bits）：数据位是要传输的实际数据，可以是8位、9位或其他位数，取决于USART的设置。
3. 校验位（Parity Bit）：校验位用于检测传输过程中的错误。它可以是奇校验、偶校验或无校验。校验位的值由数据位中的比特数目和奇偶性决定。
4. 停止位（Stop Bit）：停止位表示数据帧的结束。它通常为逻辑高电平（1）。

数据帧的格式可以根据应用的需求进行配置。常见的数据帧格式包括：

1. 8N1：8个数据位，无校验位，1个停止位。
2. 8E1：8个数据位，偶校验，1个停止位。
3. 8O1：8个数据位，奇校验，1个停止位。
4. 其他配置：可以有其他数据位、校验位和停止位的组合，例如9位数据帧。

发送端和接收端在通信过程中需要按照相同的数据帧格式进行配置，以确保正确的数据传输和解析。

### STM32 使用C标准库

STM32单片机通常可以使用C标准库，包括标准的C语言函数和数据类型。然而，有时候在使用某些特定的功能或资源时，可能会遇到一些限制或不支持C标准库的情况。以下是一些常见的原因：

1. 资源限制：STM32单片机通常具有有限的存储器资源，包括闪存和RAM。使用完整的C标准库可能会占用大量的存储空间，这可能超出了芯片的可用资源。因此，在某些情况下，可以选择使用精简版的C标准库，以减少对存储器的需求。

2. 特定功能的定制化：STM32单片机通常具有丰富的外设和功能模块，例如定时器、串口、SPI、I2C等。为了更好地支持这些硬件功能，供应商可能提供了专门的驱动库或固件库，用于控制和配置这些外设。在这种情况下，可能需要使用供应商提供的专用库，而不是标准的C库。

3. 优化性能：在某些应用中，对性能的要求很高，需要直接操作寄存器和特殊的处理器指令来实现更高效的代码。在这种情况下，可能会选择使用裸机编程或特定的嵌入式库，而不是使用标准的C库。

需要注意的是，虽然某些情况下可能无法使用完整的C标准库，但仍然可以使用其他替代方案，如第三方的嵌入式库或自行编写的代码，来满足特定的需求。此外，一些供应商也提供了针对其硬件的专门支持和文档，以帮助开发者进行嵌入式开发。

Keil打开微型C标准库

![](https://pic1.imgdb.cn/item/64677ae1e03e90d8749b1e3d.jpg)







